<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Nicks polishÃ¤ndelser 1.0</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="header">
  <h1>Nicks polishÃ¤ndelser 1.0</h1>
  <p>{{ count }} hÃ¤ndelser hittades</p>
</div>

<div class="controls">
  <form id="filterForm" method="POST">
    <div class="form-row" style="align-items:center; justify-content:center;">
      <label>Period:</label>
      <select name="hours">
        <option value="3" {% if selected_hours=='3' %}selected{% endif %}>3 timmar</option>
        <option value="6" {% if selected_hours=='6' %}selected{% endif %}>6 timmar</option>
        <option value="12" {% if selected_hours=='12' %}selected{% endif %}>12 timmar</option>
        <option value="24" {% if selected_hours=='24' %}selected{% endif %}>24 timmar</option>
        <option value="all" {% if selected_hours=='all' %}selected{% endif %}>Alla</option>
      </select>

      <label>Allvarlighetsgrad:</label>
      <select name="min_seriousness">
        {% for i in range(0,11) %}
          <option value="{{ i }}" {% if min_seriousness==i %}selected{% endif %}>{{ i }}</option>
        {% endfor %}
      </select>

      <!-- Notifieringskontroller -->
      <button type="button" id="notifyToggleBtn" style="margin-left:8px;">ğŸ”” Aktivera notiser</button>
      <label style="display:inline-flex; align-items:center; margin-left:6px;">
        <input type="checkbox" id="notifyCheckbox" style="margin-right:6px;">
        Notiser aktiva
      </label>

      <a href="/manage" style="margin-left:12px; color: #4a90e2; text-decoration:none;">âš™ï¸ Hantera allvarlighetsgrader</a>
    </div>

    <div class="form-row" style="margin-top:10px;">
      <label>SÃ¶kord:</label>
      <input type="text" name="keyword" placeholder="mord, explosion..." value="{{ keyword }}">
      <label>Plats:</label>
      <input type="text" name="location" placeholder="stad eller ort" value="{{ location }}">
    </div>

    <div style="text-align:center; margin-top:10px;">
      <button type="submit" class="show-btn">Visa</button>
    </div>
  </form>
</div>

{% if events %}
  {% for e in events %}
    <div class="event" data-seriousness="{{ e.seriousness }}">
      <div class="meta">
        ğŸ•’ {{ e.time.strftime('%Y-%m-%d %H:%M') if e.time else 'OkÃ¤nd tid' }}
        &nbsp; | &nbsp; ğŸ“ {{ e.location_name }}
        &nbsp; | &nbsp; ğŸš¨ {{ e.type }}
        &nbsp; | &nbsp; âš ï¸ {{ e.effective_seriousness }}
      </div>
      <div class="summary">ğŸ“ {{ e.summary }}</div>
      <div style="margin-top:8px;">
        <a href="https://polisen.se{{ e.url }}" target="_blank">ğŸ”— LÃ¤s mer</a>
      </div>
    </div>
  {% endfor %}
{% else %}
  <div class="noevents">ğŸš« Inga hÃ¤ndelser hittades.</div>
{% endif %}

<div class="footer">
  Byt filter och tryck Visa fÃ¶r att uppdatera resultatet.
</div>

<script>
const checkbox = document.getElementById("notifyCheckbox");
const button = document.getElementById("notifyToggleBtn");

// initialize checkbox from localStorage
checkbox.checked = localStorage.getItem("notifications_enabled") === "true";

// update localStorage when checkbox changes
checkbox.addEventListener("change", () => {
  localStorage.setItem("notifications_enabled", checkbox.checked);
});

// toggle checkbox when button is clicked
button.addEventListener("click", () => {
  checkbox.checked = !checkbox.checked;
  localStorage.setItem("notifications_enabled", checkbox.checked);
  alert(`Notiser Ã¤r ${checkbox.checked ? "aktiva" : "inaktiva"}`);
});

// request permission for notifications
if ("Notification" in window && Notification.permission !== "granted") {
  Notification.requestPermission();
}

// fetch new events every minute
async function checkForNewEvents() {
  if (!checkbox.checked) return;

  try {
    const response = await fetch("/check_new_events");
    if (!response.ok) return;

    const events = await response.json();
    for (const e of events) {
      new Notification(`ğŸš¨ ${e.type} (${e.seriousness})`, {
        body: `${e.location}: ${e.summary}`,
        icon: "/static/police.png"
      });
    }
  } catch (err) {
    console.error("Fel vid notiskontroll:", err);
  }
}

// check every 60 seconds
setInterval(checkForNewEvents, 60000);
</script>

</body>
</html>



  {% if events %}
    {% for e in events %}
      <div class="event" data-seriousness="{{ e.effective_seriousness }}">
        <div class="meta">
          ğŸ•’ {{ e.time.strftime('%Y-%m-%d %H:%M') if e.time else 'OkÃ¤nd tid' }}
          &nbsp; | &nbsp; ğŸ“ {{ e.location_name }}
          &nbsp; | &nbsp; ğŸš¨ {{ e.type }}
          &nbsp; | &nbsp; âš ï¸ {{ e.seriousness }}
        </div>
        <div class="summary">ğŸ“ {{ e.summary }}</div>
        <div style="margin-top:8px;">
          <a href="https://polisen.se{{ e.url }}" target="_blank">ğŸ”— LÃ¤s mer</a>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="noevents">ğŸš« Inga hÃ¤ndelser hittades.</div>
  {% endif %}

  <div class="footer">
    Byt filter och tryck Visa fÃ¶r att uppdatera resultatet.
  </div>
</body>
</html>
